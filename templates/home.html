<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能无人网吧管理系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        .sidebar { height: 100vh; background: #2c3e50; color: #fff; position: fixed; width: 240px; overflow-y: auto; z-index: 1000; transition: all 0.3s; }
        .sidebar-header { padding: 20px; background: #1a252f; text-align: center; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #34495e; }
        .sidebar .nav-link { color: #b8c7ce; padding: 15px 20px; border-left: 3px solid transparent; cursor: pointer; display: block; text-decoration: none; transition: 0.2s; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background: #34495e; color: #fff; border-left-color: #3498db; }
        .sidebar .nav-link i { margin-right: 10px; width: 20px; text-align: center; }
        .main-content { margin-left: 240px; padding: 20px; transition: all 0.3s; }
        
        .stat-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; }
        .bg-blue-light { background: #e3f2fd; color: #1976d2; }
        .bg-green-light { background: #e8f5e9; color: #2e7d32; }
        .bg-red-light { background: #ffebee; color: #c62828; }
        .bg-gray-light { background: #f5f5f5; color: #616161; }
        
        .seat-card { transition: all 0.3s; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; }
        .seat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .card-header-custom { padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .status-indicators { display: flex; justify-content: space-around; background: #f8f9fa; padding: 8px 0; border-bottom: 1px solid #eee; border-top: 1px solid #eee; }
        .status-item { text-align: center; font-size: 0.85rem; color: #6c757d; }
        .status-item i { font-size: 1.1rem; display: block; margin-bottom: 2px; }
        
        .control-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; }
        .btn-ctrl { padding: 5px; font-size: 0.8rem; border-radius: 6px; }
        
        .text-active { color: #28a745 !important; }
        .text-inactive { color: #adb5bd !important; }
        .text-warning-custom { color: #ffc107 !important; }
        .text-danger-custom { color: #dc3545 !important; }
        .device-offline { filter: grayscale(100%); opacity: 0.75; pointer-events: none; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        iframe { width: 100%; height: calc(100vh - 80px); border: none; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-microchip"></i> 智能无人网吧
        </div>
        <nav class="nav flex-column mt-3">
            <div class="nav-link active" onclick="switchView('dashboard', this)"><i class="fas fa-desktop"></i> 设备监控</div>
            <div class="nav-link" onclick="switchView('users', this, '/users')"><i class="fas fa-users"></i> 会员管理</div>
            <div class="nav-link" onclick="switchView('logs_sessions', this, '/logs/sessions')"><i class="fas fa-history"></i> 上机记录</div>
            <div class="nav-link" onclick="switchView('logs_alarms', this, '/logs/alarms')"><i class="fas fa-bell"></i> 报警日志</div>
            <div class="nav-link" onclick="switchView('report', this, '/report/revenue_daily')"><i class="fas fa-chart-line"></i> 营收报表</div>
            <div class="nav-link" onclick="switchView('broadcast', this, '/broadcast')"><i class="fas fa-bullhorn"></i> 广播消息</div>
            <div class="nav-link" onclick="switchView('settings', this, '/settings')"><i class="fas fa-cog"></i> 系统设置</div>
        </nav>
    </div>

    <div class="main-content">
        <div id="dashboard-view">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="fas fa-tachometer-alt text-primary"></i> 终端控制中心</h4>
                <div>
                    <span class="badge bg-white text-dark border me-2 p-2">
                        <i class="far fa-clock text-primary"></i> <span id="real-time-clock">--:--:--</span>
                    </span>
                    <button class="btn btn-sm btn-primary" onclick="updateSeats()"><i class="fas fa-sync"></i> 刷新数据</button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-blue-light"><i class="fas fa-tv"></i></div>
                        <div><h3 class="mb-0" id="count-total">0</h3><div class="text-muted small">总设备</div></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-green-light"><i class="fas fa-user-check"></i></div>
                        <div><h3 class="mb-0" id="count-using">0</h3><div class="text-muted small">在线用户</div></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-gray-light"><i class="fas fa-moon"></i></div>
                        <div><h3 class="mb-0" id="count-idle">0</h3><div class="text-muted small">当前空闲</div></div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon bg-red-light"><i class="fas fa-unlink"></i></div>
                        <div><h3 class="mb-0" id="count-offline">0</h3><div class="text-muted small">离线设备</div></div>
                    </div>
                </div>
            </div>

            <div class="row" id="devices-container">
                </div>
        </div>

        <div id="iframe-container" style="display: none;">
            <iframe id="content-frame" src=""></iframe>
        </div>
    </div>

    <div class="modal fade" id="msgModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope"></i> 发送消息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="msgTargetId">
                    <div class="mb-3">
                        <label class="form-label">目标设备:</label>
                        <input type="text" class="form-control" id="msgTargetDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">内容:</label>
                        <textarea class="form-control" id="msgContent" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitMsg()">发送</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alarmPopup" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger border-3">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle fa-blink"></i> 系统报警警示</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="fas fa-bell fa-4x text-danger mb-3 blink"></i>
                    <h4 class="text-danger fw-bold" id="alarm-title">发现异常报警!</h4>
                    <p class="lead" id="alarm-text">检测到座位发生异常，请立即查看。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">我知道了</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        var alarmModal; 
        var lastAlarmState = false; // 记录上次是否有报警，防止弹窗无限弹

        document.addEventListener('DOMContentLoaded', function() {
            alarmModal = new bootstrap.Modal(document.getElementById('alarmPopup'));
            startClock(); // 启动实时时钟
        });

        // ★★★ 实时时钟功能 (每秒刷新) ★★★
        function startClock() {
            setInterval(function() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                $('#real-time-clock').text(timeStr);
            }, 1000);
        }

        function switchView(viewName, element, url = '') {
            $('.nav-link').removeClass('active');
            $(element).addClass('active');
            if (viewName === 'dashboard') {
                $('#dashboard-view').show(); $('#iframe-container').hide();
            } else {
                $('#dashboard-view').hide(); $('#iframe-container').show();
                $('#content-frame').attr('src', url);
            }
        }

        function formatTime(seconds) {
            if (!seconds) return "00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            if(h>0) return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function updateSeats() {
            $.getJSON('/api/seats_status', function(data) {
                const container = $('#devices-container');
                container.empty();

                let total = 0, using = 0, idle = 0, offline = 0;
                let hasAlarm = false; // 本次刷新是否有报警
                let alarmDetails = "";

                $.each(data, function(id, info) {
                    total++;
                    
                    let isOffline = info.offline;
                    let statusBadge = '';
                    let cardClass = '';
                    
                    if (isOffline) {
                        offline++;
                        statusBadge = '<span class="badge bg-secondary">离线</span>';
                        cardClass = 'device-offline';
                    } else if (info.maint) {
                        offline++;
                        statusBadge = '<span class="badge bg-warning text-dark"><i class="fas fa-tools"></i> 维护中</span>';
                    } else if (info.status === 2) { 
                        // ★★★ 检测到报警状态 ★★★
                        using++;
                        hasAlarm = true;
                        alarmDetails = `设备 ${id} 发生异常 (烟雾/占座)`;
                        statusBadge = '<span class="badge bg-danger blink">报警中</span>';
                        cardClass = 'border-danger border-2'; // 卡片变红框
                    } else if (info.status === 1) {
                        using++;
                        statusBadge = '<span class="badge bg-success">使用中</span>';
                    } else {
                        idle++;
                        statusBadge = '<span class="badge bg-info">空闲</span>';
                    }

                    // 图标颜色
                    let smokeColor = info.smoke > 50 ? 'text-danger-custom blink' : 'text-success';
                    let smokeIcon = info.smoke > 50 ? 'fa-fire' : 'fa-smoking';

                    // 按钮逻辑
                    let btnMaint = info.maint ? 
                        `<button class="btn btn-ctrl btn-warning w-100" onclick="control('${id}', 'maint_off')"><i class="fas fa-check"></i> 结束维护</button>` : 
                        `<button class="btn btn-ctrl btn-outline-warning w-100" onclick="control('${id}', 'maint_on')"><i class="fas fa-tools"></i> 设为维护</button>`;

                    let btnPC = info.pc ? 
                        `<button class="btn btn-ctrl btn-success w-100" onclick="control('${id}', 'pc_off')"><i class="fas fa-power-off"></i> 关机</button>` : 
                        `<button class="btn btn-ctrl btn-outline-secondary w-100" onclick="control('${id}', 'pc_on')"><i class="fas fa-power-off"></i> 开机</button>`;

                    let btnLight = info.light ? 
                        `<button class="btn btn-ctrl btn-warning w-100 text-white" onclick="control('${id}', 'light_off')"><i class="fas fa-lightbulb"></i> 关灯</button>` : 
                        `<button class="btn btn-ctrl btn-outline-secondary w-100" onclick="control('${id}', 'light_on')"><i class="fas fa-lightbulb"></i> 开灯</button>`;

                    const html = `
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="card seat-card ${cardClass}">
                                <div class="card-header-custom bg-white border-bottom">
                                    <span class="text-primary"><i class="fas fa-desktop"></i> ${id}</span>
                                    ${statusBadge}
                                </div>
                                <div class="status-indicators">
                                    <div class="status-item"><i class="fas fa-desktop ${info.pc ? 'text-active' : 'text-inactive'}"></i><span>电脑</span></div>
                                    <div class="status-item"><i class="fas fa-lightbulb ${info.light ? 'text-warning-custom' : 'text-inactive'}"></i><span>灯光</span></div>
                                    <div class="status-item"><i class="fas fa-user ${info.human ? 'text-active' : 'text-inactive'}"></i><span>${info.human ? '有人' : '无人'}</span></div>
                                    <div class="status-item"><i class="fas ${smokeIcon} ${smokeColor}"></i><span class="${smokeColor}">${info.smoke}%</span></div>
                                </div>
                                <div class="card-body py-2 px-3 small">
                                    <div class="d-flex justify-content-between mb-1"><span class="text-muted">当前用户:</span><span class="fw-bold text-dark">${info.user}</span></div>
                                    <div class="d-flex justify-content-between mb-1"><span class="text-muted">上机时长:</span><span>${formatTime(info.sec)}</span></div>
                                    <div class="d-flex justify-content-between mb-1"><span class="text-muted">产生费用:</span><span class="text-danger fw-bold">¥${info.fee.toFixed(2)}</span></div>
                                </div>
                                <div class="control-grid bg-light border-top">
                                    <div>${btnPC}</div> <div>${btnLight}</div> <div><button class="btn btn-ctrl btn-outline-danger w-100" onclick="control('${id}', 'checkout')"><i class="fas fa-sign-out-alt"></i> 下机</button></div>
                                    <div><button class="btn btn-ctrl btn-outline-primary w-100" onclick="openMsgModal('${id}')"><i class="fas fa-envelope"></i> 消息</button></div> <div>${btnMaint}</div> <div><button class="btn btn-ctrl btn-outline-info w-100" onclick="control('${id}', 'reset')"><i class="fas fa-redo"></i> 复位</button></div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(html);
                });

                // ★★★ 触发报警弹窗逻辑 ★★★
                if (hasAlarm && !lastAlarmState) {
                    $('#alarm-text').text(alarmDetails);
                    alarmModal.show();
                    // 播放简单的提示音 (可选)
                    // const audio = new Audio('/static/alert.mp3'); audio.play().catch(e=>{});
                }
                lastAlarmState = hasAlarm; // 记录状态，防止一直弹

                $('#count-total').text(total);
                $('#count-using').text(using);
                $('#count-idle').text(idle);
                $('#count-offline').text(offline);
            });
        }

        function control(deviceId, command) {
            if ((command === 'checkout' || command === 'reset') && !confirm(`确定执行 [${command}] 吗？`)) return;
            $.post('/api/cmd', { device_id: deviceId, command: command }, function(res) {
                if(res.status === 'ok') setTimeout(updateSeats, 200); else alert('指令失败');
            });
        }

        var msgModal = new bootstrap.Modal(document.getElementById('msgModal'));
        function openMsgModal(deviceId) {
            $('#msgTargetId').val(deviceId); $('#msgTargetDisplay').val(deviceId); $('#msgContent').val('');
            msgModal.show();
        }
        function submitMsg() {
            const did = $('#msgTargetId').val(), txt = $('#msgContent').val();
            if(!txt) return;
            $.post('/api/cmd', { device_id: did, command: 'msg', value: txt }, function(res) {
                if(res.status==='ok') { alert('已发送'); msgModal.hide(); } else alert('失败');
            });
        }

        setInterval(updateSeats, 3000);
        updateSeats();
    </script>
</body>
</html>
