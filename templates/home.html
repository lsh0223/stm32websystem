<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>实时监控</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 隐藏内部页面的导航栏，因为外层已经有了 */
        .navbar { display: none !important; }
        body { padding-top: 20px; }
    </style>
  </head>
  <body class="bg-light">
    
    <div class="container">
      <div class="row g-4">
        {% for seat in seats %}
        <div class="col-md-4 col-lg-3">
          <div class="card h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0" id="name-{{ seat.device_id }}">{{ seat.seat_name_display }}</h5>
              <span id="badge-{{ seat.device_id }}" class="{{ seat.status_class }}">{{ seat.status_text }}</span>
            </div>
            <div class="card-body">
              <p id="user-info-{{ seat.device_id }}" class="card-text text-primary small fw-bold mb-2 {% if seat.current_status != 1 %}d-none{% endif %}">
                {{ seat.user_info_display }}
              </p>
              
              <ul class="list-group list-group-flush mb-3">
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>电脑</span> <span id="pc-{{ seat.device_id }}" class="fw-bold">{{ seat.pc_text }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>灯光</span> <span id="light-{{ seat.device_id }}" class="fw-bold">{{ seat.light_text }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>人体</span> <span id="human-{{ seat.device_id }}" class="fw-bold">{{ seat.human_text }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>烟雾</span> 
                  <span id="smoke-{{ seat.device_id }}">
                    {{ seat.smoke_percent }}% ({{ seat.smoke_level }})
                  </span>
                </li>
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>时长</span> <span id="time-{{ seat.device_id }}">{{ seat.duration_min }} 分</span>
                </li>
                <li class="list-group-item d-flex justify-content-between p-1">
                  <span>费用</span> <span id="fee-{{ seat.device_id }}" class="text-success fw-bold">¥ {{ seat.current_fee_fmt }}</span>
                </li>
              </ul>

              <div class="d-grid gap-2">
                <div class="btn-group btn-group-sm">
                  <a href="/seat/{{ seat.device_id }}/pc_on" class="btn btn-outline-success">开机</a>
                  <a href="/seat/{{ seat.device_id }}/pc_off" class="btn btn-outline-danger">关机</a>
                </div>
                <div class="btn-group btn-group-sm">
                  <a href="/seat/{{ seat.device_id }}/light_on" class="btn btn-outline-success">开灯</a>
                  <a href="/seat/{{ seat.device_id }}/light_off" class="btn btn-outline-secondary">关灯</a>
                </div>
                
                <a id="btn-checkout-{{ seat.device_id }}" 
                   href="{% if seat.current_status == 1 %}/seat/{{ seat.device_id }}/checkout{% else %}#{% endif %}" 
                   class="btn btn-sm {% if seat.current_status == 1 %}btn-warning{% else %}btn-secondary disabled{% endif %}">
                   强制下机
                </a>

                <form action="/msg/{{ seat.device_id }}" method="POST" class="input-group input-group-sm mt-2">
                  <input type="text" name="msg" class="form-control" placeholder="短消息...">
                  <button class="btn btn-outline-primary" type="submit">发送</button>
                </form>
                
                <a href="/seat/{{ seat.device_id }}/reset" class="btn btn-sm btn-outline-dark mt-2" onclick="return confirm('确定要远程复位 STM32 吗？');">远程复位</a>

                <div class="mt-2 text-center">
                  <a id="link-maint-{{ seat.device_id }}" 
                     href="/seat/{{ seat.device_id }}/{% if seat.is_maintenance %}maint_off{% else %}maint_on{% endif %}" 
                     class="text-decoration-none small {% if seat.is_maintenance %}text-success{% else %}text-secondary{% endif %}">
                     {% if seat.is_maintenance %}结束维护{% else %}设为维护{% endif %}
                  </a>
                </div>

              </div>
            </div>
            <div class="card-footer text-muted small">
              更新: <span id="update-{{ seat.device_id }}">{{ seat.last_update }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function updateSeats() {
        fetch('/api/seats')
          .then(response => response.json())
          .then(data => {
            data.forEach(seat => {
              const did = seat.device_id;
              
              const nameEl = document.getElementById(`name-${did}`);
              if(nameEl) nameEl.innerText = seat.seat_name_display;
              
              const badgeEl = document.getElementById(`badge-${did}`);
              if(badgeEl) {
                badgeEl.className = seat.status_class;
                badgeEl.innerText = seat.status_text;
              }

              const userEl = document.getElementById(`user-info-${did}`);
              if(userEl) {
                userEl.innerText = seat.user_info_display;
                if(seat.current_status === 1) userEl.classList.remove('d-none');
                else userEl.classList.add('d-none');
              }

              const pcEl = document.getElementById(`pc-${did}`);
              if(pcEl) pcEl.innerText = seat.pc_text;

              const lightEl = document.getElementById(`light-${did}`);
              if(lightEl) lightEl.innerText = seat.light_text;

              const humanEl = document.getElementById(`human-${did}`);
              if(humanEl) humanEl.innerText = seat.human_text;

              const smokeEl = document.getElementById(`smoke-${did}`);
              if(smokeEl) {
                smokeEl.innerText = `${seat.smoke_percent}% (${seat.smoke_level})`;
                if(seat.smoke_percent >= 60) smokeEl.classList.add('text-danger', 'fw-bold');
                else smokeEl.classList.remove('text-danger', 'fw-bold');
              }

              const timeEl = document.getElementById(`time-${did}`);
              if(timeEl) timeEl.innerText = `${seat.duration_min} 分`;

              const feeEl = document.getElementById(`fee-${did}`);
              if(feeEl) feeEl.innerText = `¥ ${seat.current_fee_fmt}`;

              const btnCheck = document.getElementById(`btn-checkout-${did}`);
              if(btnCheck) {
                if(seat.current_status === 1) {
                  btnCheck.className = "btn btn-sm btn-warning";
                  btnCheck.href = `/seat/${did}/checkout`;
                  btnCheck.classList.remove('disabled');
                } else {
                  btnCheck.className = "btn btn-sm btn-secondary disabled";
                  btnCheck.href = "#";
                }
              }

              const linkMaint = document.getElementById(`link-maint-${did}`);
              if(linkMaint) {
                if(seat.is_maintenance) {
                  linkMaint.innerText = "结束维护";
                  linkMaint.href = `/seat/${did}/maint_off`;
                  linkMaint.className = "text-decoration-none small text-success";
                } else {
                  linkMaint.innerText = "设为维护";
                  linkMaint.href = `/seat/${did}/maint_on`;
                  linkMaint.className = "text-decoration-none small text-secondary";
                }
              }

              const updateEl = document.getElementById(`update-${did}`);
              if(updateEl) updateEl.innerText = seat.last_update;
            });
          })
          .catch(err => console.error('Fetch error:', err));
      }
      setInterval(updateSeats, 3000);
    </script>
  </body>
</html>
