<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ™ºèƒ½æ— äººç½‘å§ç³»ç»Ÿ - ç›‘æ§å¤§å±</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .seat-card { margin-bottom: 20px; transition: all 0.3s; border-radius: 10px; }
        .seat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* çŠ¶æ€æ ·å¼ */
        .status-idle { border-top: 4px solid #28a745; } 
        .status-inuse { border-top: 4px solid #007bff; background-color: #f8fbff; }
        .status-alarm { border-top: 4px solid #dc3545; background-color: #fff5f5; animation: pulse 1s infinite; }
        .status-maint { border-top: 4px solid #ffc107; background-color: #fffbf0; }
        .status-offline { border-top: 4px solid #6c757d; background-color: #f8f9fa; opacity: 0.8; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
        
        .card-header { background: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .btn-group-xs > .btn, .btn-xs { padding: .25rem .4rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow mb-4">
  <div class="container">
    <a class="navbar-brand" href="/"><i class="fas fa-network-wired me-2"></i>æ™ºèƒ½æ— äººç½‘å§ç³»ç»Ÿ</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="/"><i class="fas fa-desktop me-1"></i>å®æ—¶ç›‘æ§</a></li>
            <li class="nav-item"><a class="nav-link" href="/users"><i class="fas fa-users me-1"></i>ç”¨æˆ·ç®¡ç†</a></li>
            <li class="nav-item"><a class="nav-link" href="/logs/sessions"><i class="fas fa-history me-1"></i>ä¸Šæœºè®°å½•</a></li>
            <li class="nav-item"><a class="nav-link" href="/logs/alarms"><i class="fas fa-exclamation-triangle me-1"></i>æŠ¥è­¦æ—¥å¿—</a></li>
            <li class="nav-item"><a class="nav-link" href="/report/revenue_daily"><i class="fas fa-chart-line me-1"></i>è¥æ”¶æŠ¥è¡¨</a></li>
        </ul>
    </div>
  </div>
</nav>

<div class="container">
    <div class="modal fade" id="alarmModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger shadow-lg">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="fas fa-radiation-alt me-2"></i>ç´§æ€¥æŠ¥è­¦</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopAlarmSound()"></button>
          </div>
          <div class="modal-body text-center py-4">
            <div class="display-1 text-danger mb-3"><i class="fas fa-bell fa-shake"></i></div>
            <h3 id="alarmTitle" class="text-danger fw-bold">æ£€æµ‹åˆ°å¼‚å¸¸ï¼</h3>
            <p class="fs-5 mt-3" id="alarmMsg"></p>
            <p class="text-muted small border-top pt-2 mt-3" id="alarmTime"></p>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal" onclick="stopAlarmSound()">çŸ¥æ™“å¹¶å…³é—­</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="msgModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">å‘é€æ¶ˆæ¯</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="msgDeviceId">
            <div class="mb-3">
              <label class="form-label">æ¶ˆæ¯å†…å®¹ï¼š</label>
              <input type="text" class="form-control" id="msgContent" placeholder="è¯·è¾“å…¥è¦å‘é€åˆ°å±å¹•çš„æ–‡å­—">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="sendMsgSubmit()">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row" id="deviceList">
        <div class="col-12 text-center py-5" id="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">æ­£åœ¨è¿æ¥è®¾å¤‡...</p>
        </div>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

<script>
    // æŠ¥è­¦éŸ³æ•ˆ
    var alarmAudio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); 
    alarmAudio.loop = true;
    
    var alarmModal, msgModal;
    var lastAlarmState = false;

    $(document).ready(function(){
        alarmModal = new bootstrap.Modal(document.getElementById('alarmModal'));
        msgModal = new bootstrap.Modal(document.getElementById('msgModal'));
        setInterval(refreshStatus, 1000); // 1ç§’è½®è¯¢
        refreshStatus();
    });

    function refreshStatus() {
        $.getJSON('/api/seats_status', function(data) {
            $('#loading').hide();
            var container = $('#deviceList');
            container.empty();
            
            var hasAlarm = false;

            $.each(data, function(did, dev) {
                var statusClass = 'status-idle';
                var statusText = 'ç©ºé—²';
                var badgeClass = 'bg-success';
                var icon = 'fa-check-circle';

                // çŠ¶æ€åˆ¤æ–­é€»è¾‘
                if (dev.offline) {
                    statusClass = 'status-offline'; statusText = 'ç¦»çº¿'; badgeClass = 'bg-secondary'; icon = 'fa-power-off';
                } else if (dev.status == 2) { 
                    statusClass = 'status-alarm'; statusText = 'æŠ¥è­¦ä¸­'; badgeClass = 'bg-danger'; icon = 'fa-exclamation-triangle';
                    hasAlarm = true;
                    showAlarm(did, dev);
                } else if (dev.maint) { 
                    statusClass = 'status-maint'; statusText = 'ç»´æŠ¤ä¸­'; badgeClass = 'bg-warning text-dark'; icon = 'fa-tools';
                } else if (dev.status == 1) {
                    statusClass = 'status-inuse'; statusText = 'ä½¿ç”¨ä¸­'; badgeClass = 'bg-primary'; icon = 'fa-user';
                }

                // åŠ¨æ€ç”Ÿæˆå¡ç‰‡
                var html = `
                <div class="col-md-4 col-lg-3">
                    <div class="card seat-card h-100 shadow-sm ${statusClass}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-desktop me-2 text-muted"></i>${did}</h5>
                            <span class="badge ${badgeClass}"><i class="fas ${icon} me-1"></i>${statusText}</span>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-3">
                                <div class="col-6"><small class="text-muted">ç”¨æˆ·:</small><br><strong>${dev.user}</strong></div>
                                <div class="col-6"><small class="text-muted">æ—¶é•¿:</small><br>${Math.floor(dev.sec/60)} åˆ†é’Ÿ</div>
                                <div class="col-6"><small class="text-muted">è´¹ç”¨:</small><br>Â¥${dev.fee}</div>
                                <div class="col-6"><small class="text-muted">çƒŸé›¾:</small><br>
                                    <span class="${dev.smoke > 60 ? 'text-danger fw-bold' : 'text-success'}">${dev.smoke}%</span>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="cmd('${did}', 'pc_on')" title="å¼€æœº"><i class="fas fa-power-off"></i></button>
                                    <button class="btn btn-outline-secondary" onclick="cmd('${did}', 'pc_off')" title="å…³æœº"><i class="fas fa-stop"></i></button>
                                    <button class="btn btn-outline-warning" onclick="cmd('${did}', 'light_on')" title="å¼€ç¯"><i class="fas fa-lightbulb"></i></button>
                                    <button class="btn btn-outline-dark" onclick="cmd('${did}', 'light_off')" title="å…³ç¯"><i class="far fa-lightbulb"></i></button>
                                </div>
                                
                                ${dev.status == 1 ? 
                                  `<button class="btn btn-sm btn-danger" onclick="cmd('${did}', 'checkout')"><i class="fas fa-sign-out-alt me-1"></i>å¼ºåˆ¶ä¸‹æœºç»“ç®—</button>` : 
                                  `<button class="btn btn-sm btn-secondary disabled">å¼ºåˆ¶ä¸‹æœºç»“ç®—</button>`
                                }

                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-info text-white" onclick="openMsgModal('${did}')"><i class="fas fa-comment-alt"></i> æ¶ˆæ¯</button>
                                    <button class="btn btn-secondary" onclick="cmd('${did}', 'reset')"><i class="fas fa-sync"></i> å¤ä½</button>
                                </div>

                                ${dev.maint ? 
                                  `<button class="btn btn-sm btn-success" onclick="cmd('${did}', 'maint_off')"><i class="fas fa-check me-1"></i>ç»“æŸç»´æŠ¤</button>` :
                                  `<button class="btn btn-sm btn-warning" onclick="cmd('${did}', 'maint_on')"><i class="fas fa-wrench me-1"></i>è®¾ä¸ºç»´æŠ¤</button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>`;
                container.append(html);
            });

            // æŠ¥è­¦å£°éŸ³æ§åˆ¶
            if (!hasAlarm) stopAlarmSound();
        });
    }

    // æ˜¾ç¤ºçº¢è‰²æŠ¥è­¦å¼¹çª—
    function showAlarm(did, dev) {
        if (!lastAlarmState) { 
            var type = dev.smoke > 60 ? "ğŸ”¥ ä¸¥é‡çƒŸé›¾æŠ¥è­¦" : "âš ï¸ éæ³•å åº§æŠ¥è­¦";
            var msg = `<strong>è®¾å¤‡ ${did}</strong> å‘ç”Ÿå¼‚å¸¸ï¼<br>å½“å‰çƒŸé›¾æµ“åº¦: <span class="text-danger fw-bold">${dev.smoke}%</span>`;
            
            $('#alarmTitle').text(type);
            $('#alarmMsg').html(msg);
            $('#alarmTime').text("æŠ¥è­¦æ—¶é—´: " + new Date().toLocaleTimeString());
            
            alarmModal.show();
            alarmAudio.play().catch(e=>{}); 
            lastAlarmState = true;
        }
    }

    function stopAlarmSound() {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
        lastAlarmState = false;
    }

    function cmd(id, c, val) {
        if(!confirm("ç¡®å®šæ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ")) return;
        $.post('/api/cmd', { device_id: id, command: c, value: val }, function(res){
            if(res.status === 'ok') {
                // å¯åŠ ä¸ªToastæç¤º
            }
        });
    }

    function openMsgModal(did) {
        $('#msgDeviceId').val(did);
        $('#msgContent').val('');
        msgModal.show();
    }

    function sendMsgSubmit() {
        var did = $('#msgDeviceId').val();
        var txt = $('#msgContent').val();
        if(txt) {
            $.post('/api/cmd', { device_id: did, command: 'msg', value: txt });
            msgModal.hide();
        }
    }
</script>
</body>
</html>
