<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>智能无人网吧后台管理</title>
    <!-- 每 5 秒自动刷新一次页面，做到“伪实时” -->
    <meta http-equiv="refresh" content="5">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CDN 样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        body {
            background-color: #f5f6fa;
        }
        .seat-card {
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-radius: 12px;
            margin-bottom: 12px;
            background-color: #ffffff;
        }
        .seat-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
            margin-bottom: 4px;
        }
        .seat-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .small-label {
            color: #555;
            font-size: 0.86rem;
        }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="mb-0">智能无人网吧后台管理</h3>
            <div class="text-muted small">
                页面每 5 秒自动刷新一次
            </div>
        </div>
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">座位列表</a>
            <a href="{{ url_for('users_list') }}" class="btn btn-sm btn-outline-primary">用户管理</a>
            <a href="{{ url_for('broadcast') }}" class="btn btn-sm btn-outline-success">消息广播</a>
            <a href="{{ url_for('logs_sessions') }}" class="btn btn-sm btn-outline-dark">上机日志</a>
            <a href="{{ url_for('logs_alarms') }}" class="btn btn-sm btn-outline-danger">告警日志</a>
            <a href="{{ url_for('report_revenue_daily') }}" class="btn btn-sm btn-outline-warning">每日收入报表</a>
        </div>
    </div>

    <div class="mb-2 text-muted small">
        当前终端数量：{{ seats|length }}
    </div>

    {% if seats %}
        <div class="row">
            {% for s in seats %}
            <div class="col-md-4 col-lg-3">
                <div class="seat-card p-3">
                    <div class="seat-header d-flex justify-content-between align-items-center">
                        <div class="seat-title">
                            {{ s.seat_name or s.device_id }}
                            <span class="{{ s.status_class }} ms-2">{{ s.status_text }}</span>
                            {% if s.is_maintenance %}
                                <span class="badge bg-warning text-dark ms-1">维</span>
                            {% endif %}
                            {% if s.is_offline %}
                                <span class="badge bg-dark ms-1">离线</span>
                            {% endif %}
                        </div>
                        <div class="small text-muted">
                            {{ s.device_id }}
                        </div>
                    </div>

                    <div class="mb-1 small-label">
                        电脑：
                        {% if s.pc_status %}
                            <span class="text-success fw-semibold">开机</span>
                        {% else %}
                            <span class="text-secondary fw-semibold">关机</span>
                        {% endif %}
                        &nbsp;&nbsp;灯光：
                        {% if s.light_status %}
                            <span class="text-warning fw-semibold">开启</span>
                        {% else %}
                            <span class="text-secondary fw-semibold">关闭</span>
                        {% endif %}
                    </div>

                    <div class="mb-1 small-label">
                        座位：
                        {% if s.human_status %}
                            <span class="text-danger fw-semibold">有人</span>
                        {% else %}
                            <span class="text-secondary fw-semibold">无人</span>
                        {% endif %}
                        &nbsp;&nbsp;烟雾：
                        <span class="fw-semibold">
                            {{ s.smoke_percent }}%
                            （{{ s.smoke_level }}）
                        </span>
                    </div>

                    <div class="mb-1 small-label">
                        已用时长：
                        {{ (s.current_sec // 60) }} 分 {{ (s.current_sec % 60) }} 秒
                        &nbsp;&nbsp;费用：
                        {{ s.current_fee_fmt }} 元
                    </div>

                    <div class="mb-2 small text-muted">
                        最近上报：{{ s.last_update }}
                    </div>

                    <div class="d-flex flex-wrap gap-1 mb-1">
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='pc_on') }}"
                           class="btn btn-sm btn-success {% if s.is_offline %}disabled{% endif %}">
                            远程开机
                        </a>
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='pc_off') }}"
                           class="btn btn-sm btn-outline-danger {% if s.is_offline %}disabled{% endif %}">
                            远程关机
                        </a>
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='light_on') }}"
                           class="btn btn-sm btn-warning {% if s.is_offline %}disabled{% endif %}">
                            开灯
                        </a>
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='light_off') }}"
                           class="btn btn-sm btn-outline-secondary {% if s.is_offline %}disabled{% endif %}">
                            关灯
                        </a>
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='checkout') }}"
                           class="btn btn-sm btn-outline-primary {% if s.is_offline %}disabled{% endif %}">
                            下机结算
                        </a>
                        <a href="{{ url_for('seat_action', device_id=s.device_id, action='reset') }}"
                           class="btn btn-sm btn-outline-danger {% if s.is_offline %}disabled{% endif %}">
                            远程复位
                        </a>
                        {% if s.is_maintenance %}
                            <a href="{{ url_for('seat_action', device_id=s.device_id, action='maint_off') }}"
                               class="btn btn-sm btn-outline-dark">
                                结束维护
                            </a>
                        {% else %}
                            <a href="{{ url_for('seat_action', device_id=s.device_id, action='maint_on') }}"
                               class="btn btn-sm btn-outline-dark">
                                维护座位
                            </a>
                        {% endif %}
                    </div>

                    <form class="mt-1" method="post"
                          action="{{ url_for('seat_send_msg', device_id=s.device_id) }}">
                        <div class="input-group input-group-sm">
                            <input type="text" name="msg" class="form-control"
                                   placeholder="发送短消息到该座位液晶屏">
                            <button class="btn btn-outline-primary" type="submit">
                                发送
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning">
            目前 devices 表中还没有任何终端上报数据，请确认 STM32 侧 MQTT 上报正常。
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
